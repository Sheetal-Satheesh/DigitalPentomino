<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#009578">
    <title>TUCA</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="resources/images/icons/dp_192.png">
    <link rel="stylesheet" href="resources/css/style.css">
    <link rel="stylesheet" href="resources/css/board_selection.css">
    <link rel="stylesheet" href="resources/css/modal.css">
    <link rel="stylesheet" href="resources/css/load_screen.css">
    <link rel="stylesheet" href="resources/css/grid.css">
    <link rel="stylesheet" href="resources/css/settings_form.css">
    <link rel="stylesheet" style="text/css" href="resources/jsonform/bootstrap.css" />
    <script src="resources/js/multi-lang/strings.js"></script>
    <script src="resources/js/settings/settings-schema.js"></script>
    <script src="resources/js/settings/settings.js"></script>
    <script src="resources/js/settings/settings-parser.js"></script>
    <script src="resources/js/settings/translator.js"></script>
    <script src="resources/js/settings/settings-form.js"></script>
    <script src="resources/js/settings/settings-visibility.js"></script>
    <script src="resources/index.js"></script>
    <script src="resources/js/ui-template.js"></script>
    <script src="resources/js/board.js"></script>
    <script src="resources/js/visual.js"></script>
    <script src="resources/js/overlapping.js"></script>
    <script src="resources/js/pentomino.js"></script>
    <script src="resources/js/game-controller.js"></script>
    <script src="resources/js/game-loader.js"></script>
    <script src="resources/js/game.js"></script>
    <script src="resources/js/command-history/command-node.js"></script>
    <script src="resources/js/command-history/commands.js"></script>
    <script src="resources/js/command-history/command-manager.js"></script>
    <script src="resources/js/command-history/command-tree.js"></script>
    <script src="resources/js/configs/baseConfigs.js"></script>
    <script src="resources/js/configs/licensesConfig.js"></script>
    <script src="resources/js/configs/solutionsConfig.js"></script>
    <script src="resources/js/game-solution.js"></script>
    <script src="resources/js/pd.js"></script>
    <script src="resources/js/handleMobile.js"></script>
    <script type="text/javascript" src="resources/jsonform/jquery.min.js"></script>
    <script type="text/javascript" src="resources/jsonform/underscore.js"></script>
    <script type="text/javascript" src="resources/jsonform/jsonform.js"></script>
    <script type="text/javascript" src="resources/jsonform/jsv.js"></script>
    <script type="text/javascript" src="resources/jsonform/html2canvas.js"></script>
    <script type="text/javascript" src="resources/jsonform/loadash.js"></script>
    <script type="text/javascript" src="resources/jsonform/jquery.qrcode.min.js"></script>
    <script type="text/javascript" src="resources/jsonform/qr-scanner.umd.min.js"></script>
    <script type="text/javascript" src="resources/js/util.js"></script>
    <script src="resources/js/hint.js"></script>
    <script src="resources/js/hint-ai.js"></script>
    <script src="resources/js/help/hinting/command-sequence-list.js"></script>
    <script src="resources/js/load_screen.js"></script>
</head>
<!-- Preloader section -->
<div class="preloader d-flex">
    <div class="tuca">
        <img src="resources/images/icons/tuca.png" type="image/svg+xml" />
    </div>
    <div class="sk-cube-grid">
        <img src="https://i.gifer.com/YCZH.gif" />
    </div>
</div>

<body onload="touchStartup(); initialize(); buttonManipulation();" class="page">
    <audio id="audioTukaScream" src="resources/audio/tuka-scream.mp3"></audio>
    <audio id="bgMusic" src="resources/audio/chee-zee-beach-by-kevin-macleod-from-filmmusic-io.mp3" loop></audio>
    <canvas id="canvas" width="auto" height="auto"></canvas>
    <div id="seedingCover"></div>
    <div id="seeding" class="seed">
        <input type="search" id="seedBar" class="seed" placeholder="Input seed...">
        <button type="button" id='seedSubmit' class="cActionBtn" onclick="submitSeed()"><img class="cSeedBtn"
                src="resources/images/icons/seed.png">
    </div>
    <div class="cGame">
        <div id="game">
            <div id="tray"></div> <!-- tray -->
            <div id="playarea" class="FlashOff">
                <div id="field"></div> <!-- field -->
                <div id="piecearea"></div> <!-- piecearea -->
            </div>
            <div id="boardmodalTop" class="boardmodal"
                style="background: #eceaea none repeat scroll 0% 0%; display: none;">
                <span onclick="closeModal()" class="boardclose" title="Close Modal">x</span>
                <div class="boardmodalContainer" id="boardmodalContainerID">
                    <div class="boardouterGrid">
                        <div class="boardinnerGrid" id="boardinnerGrid" style="display: block;">

                        </div>
                        <form class="boardmodalFormContent" style="display: none;">
                            <form></form>
                            <div class="boardmodalFormContainer" id="boardmodalFormContainerID">
                                <h3 id="boardmodalTextID"></h3>
                                <div class="boardmodalButtons" id="boardmodalButtonsID"></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!--board modal end-->

            <div id="modalTop" class="modal">
                <button onclick="closeModal()" class="close" title="Close Modal"><img class="closeBtn"
                        src="resources/images/icons/close.png"></button>
                <button id="backButton" class="back" style="display:none"><img class="backBtn"
                        src="resources/images/icons/back.png"></button>
                <div class="modalContainer" id="modalContainerID">
                    <div class="outerGrid">
                        <div class="innerGrid" id="innerGrid"></div>
                        <form id="innerGridForm"></form>
                    </div>
                    <form class="modalFormContent">
                        <div class="modalFormContainer" id="modalFormContainerID">
                            <h3 id="modalTitleID"></h3>
                            <div class="modalButtons" id="modalButtonsID"></div>
                            <div class="modalBody" id="modalBodyID"></div>
                        </div>
                    </form>
                </div>
            </div>
            <!--modal end-->

            <div id="functions_navbar" class="nav" onclick="hideManipulationButtons">
                <button type="button" id='btnSettingsForm' class="cActionBtn" onclick="selectSettings()">
                    <img src="resources/images/icons/settings_v2.png">
                </button>
                <button type="button" id='btnBoardSelect' class="cActionBtn" onclick="selectBoard()"> <img
                        src="resources/images/icons/board_v2.png">
                </button>
                <button type="button" id='prefillBoard' class="cActionBtn" onclick="prefillBoard()" disabled>
                    <img src="resources/images/icons/prefill.png">
                </button>
                <button type="button" id='qrCodeButton' class="cActionBtn" onclick="clickedOnScanQrCode()">
                    <img src="resources/images/icons/qr-code.png">
                </button>
                <button type="button" id='hintButton' class="cActionBtn" onclick="callHintAI()"> <img
                        src="resources/images/icons/help_v2.png">
                </button>
                <button type="button" id='undo' class="cActionBtn" onclick="execUndo()">
                    <img src="resources/images/icons/undo_v2.png">
                </button>
                <button type="button" id='redo' class="cActionBtn" onclick="execRedo()"><img
                        src="resources/images/icons/redo_v2.png">
                </button>
                <button type="button" id='screenshot' class="cActionBtn" onclick="saveGameImage()">
                    <img src="resources/images/icons/screenshot_v2.png">
                </button>
                <button type="button" id='gallery' class="cActionBtn" onclick="showGameImages()">
                    <img src="resources/images/icons/gallery_v2.png">
                </button>
                <button type="button" id='replay' class="cActionBtn" onclick="execReplay()">
                    <img src="resources/images/icons/replay.svg">
                </button>
                <button type="button" id='reset' class="cActionBtn" onclick="resetGame()">
                    <img src="resources/images/icons/tidy_up_v2.png"></button>
            </div>

            <div id="labelNumberSolutionsContainer">
                <div id="labelNumberSolutionsContainerChild">
                    <div id="labelNumberSolutions">Number of solutions: ?</div>
                </div>
            </div>
            <div id="bubbleContainer">
                <div class="speechBubble">
                    <div id="speechBubbleText">Number of solutions: ?</div>
                </div>
            </div>
            <div id="birdContainer">
                <img src="resources/images/icons/tuca_bird_left.png"></img>
            </div>

        </div>
        <div class="main-wrapper" id="pieceManipulation">
            <div class="buttonWrapper first">
                <div class="buttonInside first" id="insideWrapperFirst" onclick="flipH()">
                    <span class="icon-flip1" id="OpflipH"></span>
                </div>
            </div>
            <div class="buttonWrapper second">
                <div class="buttonInside second" id="insideWrapperSecond" onclick="rotateAntiClkWise()">
                    <span class="icon-rotateLeft" id="OpRotateLeft"></span>
                </div>
            </div>
            <div class="buttonWrapper third">
                <div class="buttonInside third" id="insideWrapperThird" onclick="rotateClkWise()">
                    <span class="icon-rotateRight" id="OpRotateRight"></span>
                </div>
            </div>
            <div class="buttonWrapper fourth">
                <div class="buttonInside fourth" id="insideWrapperFourth" onclick="flipV()">
                    <span class="icon-flip2" id="OpflipV"></span>
                </div>
            </div>
        </div>
        <!---Button Manipulation Ends-->
    </div>

    <script type="text/javascript">
        let pd;
        let template;

        function initialize() {
            pd = new PD();
            template = new Template();
            loadBoardList();
            let settings = SettingsSingleton.getInstance().getSettings();
            let initialChanges = SettingsParser.compareSettings(
                SettingsSchemaSingleton.getInstance().getSettingsSchema(),
                settings,
                null);
            processChangesToSettings(initialChanges, settings);
        }

        function buttonManipulation() {
            let btn = document.querySelector('.mainWrapper');
            let buttonWrapper = document.querySelectorAll('.buttonWrapper');

            if (btn) {
                btn.addEventListener('click', function () {

                    if (btn.classList.contains('animation')) {
                        btn.classList.remove('animation');
                    } else {
                        btn.classList.add('animation');
                    }

                    for (i = 0; i < buttonWrapper.length; i++) {
                        if (buttonWrapper[i].classList.contains('animation')) {
                            buttonWrapper[i].classList.remove('animation');
                        } else {
                            buttonWrapper[i].classList.add('animation');
                        }
                    }
                });
            }

        }

        function loadBoardList() {
            let boardimageGrid = document.getElementById('boardinnerGrid');
            template.clearContent(".boardinnerGrid");

            var board_list = pd.getAllBoards();
            for (var i = 0; i < board_list.length; i++) {
                let boardimageDiv = document.createElement("div");
                boardimageDiv.setAttribute("class", "boardimageDiv");

                var imageElement = document.createElement("img");
                imageElement.setAttribute("class", "boardimage");
                imageElement.setAttribute("width", "1710");
                imageElement.setAttribute("height", "883");
                imageElement.setAttribute("style", "width: 25vw; height: 15vw; border: 2px solid black;");
                imageElement.setAttribute("class", "boardimage");

                var img_src = "resources/images/boards/" + board_list[i] + ".png";
                imageElement.setAttribute("src", img_src);
                imageElement.setAttribute("onclick", "loadBoard('" + board_list[i] + "')");
                boardimageDiv.appendChild(imageElement);
                boardimageGrid.appendChild(boardimageDiv);
            }
        }

        function clickedOnScanQrCode() {
            let modal = document.getElementById('modalTop');
            if ($(modal).is(':visible')) {
                this.closeModal();
            } else {
                openScanQrCode();
                this.disablePointerEventsOnPieces();
                this.hideManipulationButtons();
                if ($('#birdContainer').is(':visible')) {
                    this.hideBubbleContainer();
                }
            }
        }

        function openScanQrCode() {
            let modal = document.getElementById('modalTop');
            modal.style.display = "block";
            modal.style.background = "#eceaea";

            document.querySelector(".modalFormContent").style.display = "none";
            document.querySelector(".innerGrid").style.display = "block";
            template.clearContent("#modalButtonsID");
            template.clearContent("#modalTitleID");
            template.clearContent("#modalBodyID");
            template.clearContent(".innerGrid")
            template.clearContent("#innerGridForm");

            let parent = $('#innerGridForm')[0];

            let heading = document.createElement("h4");
            heading.innerHTML = "Scan QR-code";
            parent.appendChild(heading);

            let videoElement = parent.appendChild(document.createElement("video"));
            videoElement.id = "webCamera";
            videoElement.style.display = "none";
            parent.appendChild(videoElement);

            let canvasElem = parent.appendChild(document.createElement("canvas"));
            canvasElem.id = "videoCanvas";

            QrScanner.WORKER_PATH = 'resources/jsonform/qr-scanner-worker.min.js';

            const qrScanner = new QrScanner(videoElement, result => {
                let success = onQrCodeScanned(result);
                if (success) {
                    qrScanner.stop();
                    this.closeModal();
                }
            });

            qrScanner.start();

            // Draw video on canvas with rectangle
            videoElement.onplay = function () {
                setTimeout(function () {
                    drawVideoToCanvas(videoElement, canvasElem);
                }, 300);
            };

            //onQrCodeScanned("https://pentomino-digital.de/V5/index.html?t=2010101110111011101110121");
            //this.closeModal();
        }

        // from https://stackoverflow.com/questions/59702127/draw-rectangle-over-html-5-tag-video first answer
        function drawVideoToCanvas(video, canvas) {
            let ctx = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            let rectWidth = Math.min(canvas.width * (2 / 3), canvas.height * (2 / 3));

            let centerX = canvas.width / 2;
            let centerY = canvas.height / 2;

            let pX = centerX - rectWidth / 2;
            let pY = centerY - rectWidth / 2;

            ctx.rect(pX, pY, rectWidth, rectWidth);
            ctx.lineWidth = "6";
            ctx.strokeStyle = "red";
            ctx.stroke();

            setTimeout(function () {
                drawVideoToCanvas(video, canvas);
            }, 100);
        }

        function onQrCodeScanned(qrCode) {
            let url;
            try {
                url = new URL(qrCode);
            } catch (_) {
                // TODO: display error-msg to user in better way
                alert("Scanned in wrong QR-code.");
                console.error("Scanned code is not a url: " + qrCode);
                return false;
            }

            let seed = url.searchParams.get(baseConfigs.seedUrlParamName);

            if (seed === null) {
                // TODO: display error-msg to user in better way
                // No parameter for seed found
                alert("Scanned in wrong QR-code.");
                console.error("Scanned url does not contain TUCA seed: " + qrCode);
                return false;
            }

            let schema = SettingsSchemaSingleton.getInstance().getSettingsSchema();
            let newSettings = SettingsParser.parseSettingsFromSeed(schema, seed);

            if (newSettings === null) {
                // TODO: display error-msg to user in better way
                alert("Scanned in wrong QR-code.");
                console.error("Scanned seed could not be parsed into a settings configuration: " + seed);
                return false;
            }

            applyNewSettingsObjToApp(newSettings);
            insertUrlParam(baseConfigs.seedUrlParamName.toString(), seed);
            return true;
        }

        function resetGame() {
            var modal = document.getElementById('modalTop');
            if ($(modal).is(':visible')) {
                this.closeModal();
            }
            else {
                this.hideBubbleContainer();
                this.disableSnapshotButton();
                this.hideManipulationButtons();
                this.closeBoardSelector();
                this.disablePointerEventsOnPieces();
                modal.style.display = "block";
                modal.style.background = "transparent";

                document.querySelector(".modalFormContent").style.display = "block";
                document.querySelector(".innerGrid").style.display = "none";
                template.clearContent("#modalButtonsID");
                template.clearContent("#modalTitleID");
                template.clearContent("#modalBodyID");
                template.clearContent("#innerGridForm");

                let lang = SettingsSingleton.getInstance().getSettings().general.language;

                let textNode = {
                    class: "modalText",
                    text: strings.reset[lang]
                };
                template.attachText("#modalTitleID", textNode);

                let cancelBtn = {
                    class: "cancelBtn",
                    onclick: "closeModalContainer()",
                    textContent: strings.general.no[lang]
                };
                template.attachBtn("#modalButtonsID", cancelBtn);

                let deleteBtn = {
                    class: "deleteBtn",
                    onclick: "closeModalContainer()",
                    textContent: strings.general.yes[lang]
                };

                template.attachBtn("#modalButtonsID", deleteBtn);

                let dltBtn = document.querySelector(".deleteBtn");
                dltBtn.addEventListener("click", () => {
                    pd.reset();
                });
            }
        }

        function closeModal() {
            document.getElementById('boardmodalTop').style.display = 'none';
            this.closeModalContainer();
            this.enableSnapshotButton();
            if ($('#birdContainer').is(':visible')){
                this.showBubbleContainer();
            }           
        }

        function callHintAI() {
            if (!pd.gameController.game()._board.isSolved()) {
                pd.visual.callHintAI();
                this.hideManipulationButtons();
            } else {
                // TODO - handle, e.g. shake hint button
                console.log("Game is already solved. Cannot display hint");
            }
        }

        function rotateClkWise() {
            pd.rotateClkWise();
        }

        function rotateAntiClkWise() {
            pd.rotateAntiClkWise();
        }

        function flipH() {
            pd.flipH();
        }

        function flipV() {
            pd.flipV();
        }

        function prefillBoard() {
            pd.visual.prefillBoard();
            this.closeBoardSelector();
            this.closeSettings();
        }

        function execUndo() {
            this.hideManipulationButtons();
            pd.visual.undo();
        }

        function execRedo() {
            pd.visual.redo();
        }

        function selectBoard() {
            var boardSelectorPopup = document.getElementById("boardmodalTop");
            if ($(boardSelectorPopup).is(':visible')) {
                this.closeBoardSelector();
                this.enableSnapshotButton();
                this.closeModal();
            }
            else {
                boardSelectorPopup.style.display = "block";
                this.hideManipulationButtons();
                this.closeSettings();
                this.disablePointerEventsOnPieces();
                this.disableSnapshotButton();
                this.hideBubbleContainer();
            }
        }

        // From https://stackoverflow.com/questions/10970078/modifying-a-query-string-without-reloading-the-page (2nd answer)
        function insertUrlParam(key, value) {
            if (history.pushState) {
                let searchParams = new URLSearchParams(window.location.search);
                searchParams.set(key, value);
                let newURL = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + searchParams.toString();
                window.history.pushState({ path: newURL }, '', newURL);
            }
        }

        function handleJsonFormSubmit(errors, values) {
            let seed = SettingsParser.parseSettingsToSeed(SettingsSchemaSingleton.getInstance().getSettingsSchema(), values);
            // TODO: display seed somehow
            insertUrlParam(baseConfigs.seedUrlParamName.toString(), seed);

            if (errors === false) {
                event.preventDefault();
                // console.log("JsonForm: Submitted values:");
                // console.log(values);
                closeSettings();
                applyNewSettingsObjToApp(values);
            }
        }

        function applyNewSettingsObjToApp(settings) {
            let oldSettings = SettingsSingleton.getInstance().getSettings();
            let schema = SettingsSchemaSingleton.getInstance().getSettingsSchema();
            let changesToSettings = SettingsParser.compareSettings(schema, oldSettings, settings);

            SettingsSingleton.getInstance().setSettings(settings);
            processChangesToSettings(changesToSettings, settings);
        }

        function processChangesToSettings(changes, settings) {
            changes.forEach(changesEntry => {
                let heading = changesEntry.heading;
                let key = changesEntry.key;

                if (heading === "general" && key === "language") {
                    let lang = settings[heading][key];
                    document.getElementById("labelNumberSolutions").textContent = strings.numberOfPossibleSolutions[lang] + ': ?';
                    document.getElementById("speechBubbleText").textContent = strings.numberOfPossibleSolutions[lang] + ': ?';
                } else if (heading === "hinting" && key === "enableHinting") {
                    let hintingEnabled = settings[heading][key];
                    document.getElementById("hintButton").style.visibility = hintingEnabled ? "visible" : "hidden";
                } else if (heading === "hinting" && key === "showNumberOfPossibleSolutions") {
                    let showNumberOfPossibleSolutions = settings[heading][key];
                    document.getElementById("bubbleContainer").style.visibility = showNumberOfPossibleSolutions ? "visible" : "hidden";
                } else if (heading === "prefilling" && key === "enablePrefilling") {
                    let visible = settings[heading][key];
                    document.getElementById("prefillBoard").style.visibility = visible ? "visible" : "hidden";
                } else if (heading === "general" && key === "enableBgMusic") {
                    let playBgMusic = settings[heading][key];
                    let bgMusicAudio = document.getElementById("bgMusic");
                    if (playBgMusic) {
                        if (bgMusicAudio.paused || bgMusicAudio.duration === 0) {
                            bgMusicAudio.play();
                        }
                    } else {
                        if (!bgMusicAudio.paused) {
                            bgMusicAudio.pause();
                            bgMusicAudio.currentTime = 0;
                        }
                    }
                } else if (heading === "general" && key === "enableBird") {
                    let birdEnabled = settings[heading][key];
                    if (birdEnabled) {
                        document.getElementById("birdContainer").style.display = "block";
                        document.getElementById("bubbleContainer").style.display = "block";
                        document.getElementById("labelNumberSolutionsContainer").style.display = "none";
                    } else {
                        document.getElementById("birdContainer").style.display = "none";
                        document.getElementById("bubbleContainer").style.display = "none";
                        document.getElementById("labelNumberSolutionsContainer").style.display = "block";
                    }
                }
            });
        }

        function selectSettings() {
            let modal = document.getElementById('modalTop');
            if ($(modal).is(':visible')) {
                this.closeModal();
            } else {
                openSettings();
                this.disablePointerEventsOnPieces();
                this.hideManipulationButtons();
                this.hideBubbleContainer();
            }
        }

        function openSettings() {
            let modal = document.getElementById('modalTop');
            modal.style.display = "block";
            modal.style.background = "#eceaea";

            document.querySelector(".modalFormContent").style.display = "none";
            document.querySelector(".innerGrid").style.display = "block";
            template.clearContent("#modalButtonsID");
            template.clearContent("#modalTitleID");
            template.clearContent("#modalBodyID");
            template.clearContent(".innerGrid")
            template.clearContent("#innerGridForm");

            //add form to attach settings to
            //$('#innerGridForm').jsonForm({
            //    schema: SettingsSchemaSingleton.getInstance().getSettingsSchema(),
            //    onSubmit: this.handleJsonFormSubmit,
            //    displayErrors: this.handleJsonFormErrors
            //});

            SettingsForm.generateForm(
                $('#innerGridForm')[0],
                this.handleJsonFormSubmit,
                this.handleShareSettings,
                this.handleClickedOnLicenses
            );

            let settings = SettingsSingleton.getInstance().getSettings();
            SettingsForm.updateForm($('#innerGridForm')[0], settings);
            // this.postProcessSettingsForm(SettingsSingleton.getInstance().getSettings());
        }

        // called when license button is clicked in settings
        function handleClickedOnLicenses(settings) {
            this.hideManipulationButtons();
            this.closeBoardSelector();
            this.disablePointerEventsOnPieces();
            var modal = document.getElementById('modalTop');
            let modalFormContent = document.getElementsByClassName('modalFormContent');
            modal.style.display = "block";
            modal.style.background = "transparent";
            document.querySelector(".modalFormContent").style.display = "block";
            document.querySelector(".innerGrid").style.display = "none";
            template.clearContent("#modalButtonsID");
            template.clearContent("#modalTitleID");
            template.clearContent("#modalBodyID");
            template.clearContent("#innerGridForm");
            modal.style.background = "#dcf0ed";
            document.getElementById("modalFormContainerID").style.backgroundColor = "#dcf0ed";
            document.getElementById("modalFormContainerID").style.border = "none";
            let y = document.getElementsByClassName("cActionBtn");
            for(let i = 0; i< y.length; i++){ y[i].style.pointerEvents = "none"; }
            $(".modalFormContent").css( "display", "none" );
            //show back button
            let btn = document.getElementById("backButton");
            btn.style.display = "block";
            $(".close").click(function () {
              document.getElementById("modalTop").style.display = "none";
                if ($("#licencesTable")) {
                    document.getElementById("licencesTable").style.display = "none";
                    document.getElementById("licenseHeading").style.display = "none";
                    document.getElementById("tableLicenseDiv").style.display = "none";
                    for(let i = 0; i< y.length; i++){ y[i].style.pointerEvents = "auto"; }
                }
            });
            btn.onclick = function () {
                openSettings();
                document.getElementById("tableLicenseDiv").style.display = "none";
                if ($("#licencesTable")) {
                    document.getElementById("licencesTable").style.display = "none";
                    document.getElementById("licenseHeading").style.display = "none";
                    document.getElementById("tableLicenseDiv").style.display = "none";
                    for(let i = 0; i< y.length; i++){ y[i].style.pointerEvents = "auto"; }
                }
                document.getElementById("licenseHeading").style.display = "none";
                if(div5){
                  div5.style.display = "none";
                }
                SettingsForm.updateForm($('#innerGridForm')[0], settings);
                btn.style.display = "none";
            };
            let lang = SettingsSingleton.getInstance().getSettings().general.language;
            let licenceHeading = strings.License[lang];
            let h2 = document.createElement("h2");
            h2.id = "licenseHeading";
            h2.innerHTML = strings.License[lang];
            h2.style.textAlign = "center";
            let div5 = document.createElement("div");
            div5.id = "tableLicenseDiv";
            div5.style.marginTop = "10vh";
            div5.style.marginRight = "5vh";
            div5.appendChild(h2);
            let ConfigKeys = [];
            for (let h in strings.settings.license.enumTitles) {
                let i = strings.settings.license.enumTitles[h][lang];
                ConfigKeys.push(i);
            }
            modal.appendChild(document.createElement(strings.License[lang]));
            var table = document.createElement('TABLE');
            console.log(table);
            table.id = "licencesTable"
            table.border = '1px solid black';
            table.style.textAlign = "center";
            table.style.marginLeft = "2vh";
            table.style.marginRight = "auto";
            var tableBody = document.createElement('TBODY');
            table.appendChild(tableBody);
            var tr = document.createElement('TR');
            tableBody.appendChild(tr);
            var x = window.matchMedia("(max-width: 860px)")
            for (var i = 0; i < ConfigKeys.length; i++) {
                var td = document.createElement('TH');
                td.classList.add("TableHead");
                td.style.width = '20vw';
                td.style.padding = "1vw";
                td.border = '0.5vw solid black';
                td.style.borderCollapse = "collapse";
                if (x.matches) { // If media query matches
                    td.style.fontSize = "1vw";
                    td.style.width = '10vw';
                }
                else {
                    td.style.fontSize = "1vw";
                    td.style.width = '10vw';
                }
                td.appendChild(document.createTextNode(ConfigKeys[i]));
                tr.appendChild(td);
            }
            for (let heading in licensesConfig) {
                let subSettings = licensesConfig[heading];
                var tr1 = document.createElement('TR');
                var x = window.matchMedia("(max-width: 700px)");
                tableBody.appendChild(tr1);
                for (let key in subSettings) {
                    if (key === "name") {
                        var td = document.createElement('TH');
                        td.classList.add("TableNameCell");
                        let entry = subSettings[key][lang];
                        let imageElement;
                        const subString = "image";
                        if(entry.includes(subString)){
                          imageElement = document.createElement("img");
                          imageElement.setAttribute("style", "width: 10vw; height: 10vw; border: 2px solid black; text-align: center; border:transparent");
                          let img_src = "resources/images/icons/" + heading +".ico";
                          imageElement.setAttribute("src", img_src);
                          td.appendChild(imageElement);
                        }
                        td.style.width = '20vw';
                        td.style.padding = "1vw";
                        td.border = '0.5vw solid black';
                        td.style.borderCollapse = "collapse";
                        if (x.matches) { // If media query matches
                            td.style.fontSize = "1vw";
                            td.style.width = '10vw';
                        }
                        else {
                            td.style.fontSize = "1vw";
                            td.style.width = '10vw';
                        }
                        td.appendChild(document.createElement("br"));
                        td.appendChild(document.createTextNode(entry));
                    }
                    else {
                        var td = document.createElement('TH');
                        td.classList.add("TableDataCell");
                        entry = subSettings[key];
                        td.style.width = '20vw';
                        td.style.padding = "0.5vw";
                        td.border = '0.5vw solid black';
                        td.style.borderCollapse = "collapse";
                        if (x.matches) { // If media query matches
                            td.style.fontSize = "1vw";
                            td.style.width = '10vw';
                        }
                        else {
                            td.style.fontSize = "1vw";
                            td.style.width = '10vw';
                        }
                        td.appendChild(document.createTextNode(entry));
                    }
                    //tr1.appendChild(td1);
                    tr1.appendChild(td);
                }
            }
            div5.appendChild(table);
            modal.appendChild(div5);
        }

        function handleShareSettings(settings) {
            this.hideManipulationButtons();
            this.closeBoardSelector();
            this.disablePointerEventsOnPieces();
            var modal = document.getElementById('modalTop');
            modal.style.display = "block";
            modal.style.background = "transparent";

            document.querySelector(".modalFormContent").style.display = "block";
            document.querySelector(".innerGrid").style.display = "none";
            template.clearContent("#modalButtonsID");
            template.clearContent("#modalTitleID");
            template.clearContent("#modalBodyID");
            template.clearContent("#innerGridForm");

            let div1 = document.createElement("div");
            let h5 = document.createElement("h2");
            var t1 = document.createTextNode("Share");
            h5.appendChild(t1);
            div1.appendChild(h5);
            modalBodyID.appendChild(div1);

            //show back button
            let btn = document.getElementById("backButton");
            btn.style.display = "block";
            btn.onclick = function () {
                openSettings();
                SettingsForm.updateForm($('#innerGridForm')[0], settings);
                btn.style.display = "none";
            };

            let teacherURLLabel = document.createElement("label");
            let pupilURLLabel = document.createElement("label");

            let schema = SettingsSchemaSingleton.getInstance().getSettingsSchema();
            let seed = SettingsParser.parseSettingsToSeed(schema, settings);
            console.log("baseConfigs.url", baseConfigs.url);
            let teacherUrl = baseConfigs.url + "?" + baseConfigs.seedUrlParamName + "=" + seed;
            let pupilUrl = baseConfigs.url + "?" + baseConfigs.seedUrlParamName + "=2" + seed.substr(1, seed.length);
            teacherURLLabel.innerHTML = teacherUrl;
            pupilURLLabel.innerHTML = pupilUrl;

            let teacherQrCodeElement = document.createElement("div");
            let pupilQrCodeElement = document.createElement("div");
            pupilQrCodeElement.style.margin = "auto";

            generateQrCode(pupilQrCodeElement, pupilUrl);
            modalBodyID.appendChild(pupilQrCodeElement);

            /*let table = document.createElement("table");
            table.style.margin = "auto";

            let tr23 = document.createElement("tr");
            table.appendChild(tr23);
            let td111 = document.createElement("td");
            td111.appendChild(document.createTextNode("Share With Other Teachers"));
            tr23.appendChild(td111);
            let td212 = document.createElement("td");
            td212.appendChild(document.createTextNode("Use In Class"));
            tr23.appendChild(td212);

            let qrTr = generateQrTrElement(teacherUrl, pupilUrl);
            table.appendChild(qrTr);

            let tr2 = document.createElement("tr");
            table.appendChild(tr2);
            let td11 = document.createElement("td");
            td11.appendChild(document.createTextNode("Use this to share with other teachers (Restricted Settings)"));
            tr2.appendChild(td11);
            let td21 = document.createElement("td");
            td21.appendChild(document.createTextNode("Use this in class"));
            tr2.appendChild(td21);

            modalBodyID.appendChild(table);*/

            modalBodyID.appendChild(document.createElement("br"));
            modalBodyID.appendChild(document.createTextNode("Use this QR-code to bring your current settings on your pupil's devices."));

            modalBodyID.appendChild(document.createElement("br"));
            modalBodyID.appendChild(document.createTextNode("1. Print QR-code 2. The pupils scan it with the X-button in the TUCA-App."));

            modalBodyID.appendChild(document.createElement("br"));
            let printButton = SettingsForm.createButton("Print");
            printButton.setAttribute("id", "printQRCode");
            printButton.addEventListener("click", function () {
                window.print();
            });
            modalBodyID.appendChild(printButton);
            let downloadImageButton = document.createElement("a");
            downloadImageButton.innerHTML = "Download image";
            downloadImageButton.addEventListener("click", function () {
                handleDownloadImage(downloadImageButton, pupilQrCodeElement.firstElementChild);
            });
            downloadImageButton.download = "Canvas.png";
            modalBodyID.appendChild(downloadImageButton);
            modalBodyID.appendChild(document.createElement("br"));
            modalBodyID.appendChild(document.createElement("br"));

            let collapsibleButton = SettingsForm.createCollapsibleButton("Show advanced share options", "Hide advanced share options");
            let divToHide = document.createElement("div");
            divToHide.appendChild(document.createTextNode("Test"));

            modalBodyID.appendChild(collapsibleButton);
            modalBodyID.appendChild(divToHide);
        }

        function handleDownloadImage(downloadImageButton, canvasElement) {
            dlCanvas(downloadImageButton, canvasElement);
        }

        function dlCanvas(downloadImageButton, canvasElem) {
            let dt = canvasElem.toDataURL('image/png');
            downloadImageButton.href = dt;
        }


        /*function generateQrTrElement(teacherUrl, pupilUrl) {
            // Generate QR
            let teacherQrCodeElement = document.createElement("div");
            let pupilQrCodeElement = document.createElement("div");

            generateQrCode(teacherQrCodeElement, teacherUrl);
            generateQrCode(pupilQrCodeElement, pupilUrl);

            let tr = document.createElement("tr");
            let td1 = document.createElement("td");
            tr.appendChild(td1);
            let td2 = document.createElement("td");
            tr.appendChild(td2);

            td1.appendChild(teacherQrCodeElement);
            td2.appendChild(pupilQrCodeElement);

            return tr;
        }*/

        function generateQrCode(element, inputText) {
            let selector = $(element);
            selector.empty();
            // Set Size to Match User Input
            // FIXME: fix width and height
            selector.css({
                'width': 255,
                'height': 255
            });
            // Generate and Output QR Code
            selector.qrcode({
                width: 255,
                height: 255,
                text: inputText
            });
        }

        let piecesIdArray = ['piece_X', 'piece_Y', 'piece_F', 'piece_I', 'piece_L', 'piece_N', 'piece_P', 'piece_T', 'piece_U', 'piece_V', 'piece_W', 'piece_Z'];
        function disablePointerEventsOnPieces() {
            piecesIdArray.forEach(function (piece) {
                document.getElementById(piece).style.pointerEvents = "none";
            });
        }

        function enablePointerEventsOnPiece() {
            piecesIdArray.forEach(function (piece) {
                document.getElementById(piece).style.pointerEvents = "auto";
            });
        }

        function closeModalContainer() {
            document.getElementById('modalTop').style.display = "none";
            document.getElementById('backButton').style.display = "none";
            this.enablePointerEventsOnPiece();
        }

        function closeSettings() {
            this.closeModalContainer();
            //Do not remove as this will create issue while toggling between the popups
            this.enableSnapshotButton();
        }

        function closeBoardSelector() {
            document.getElementById('boardmodalTop').style.display = "none";
            this.enablePointerEventsOnPiece();
        }

        function selectSeeding() {
            document.getElementById("seedingCover").style.visibility = "visible";
            document.getElementById("seeding").style.visibility = "visible";
        }

        function closeSeeding() {
            document.getElementById("seedingCover").style.visibility = "hidden";
            document.getElementById("seeding").style.visibility = "hidden";
        }

        function hideManipulationButtons() {
            document.getElementById('pieceManipulation').style.display = 'none';
        }

        function disablePrefillButton() {
            document.getElementById('prefillBoard').disabled = 'true';
        }

        function enablePrefillButton() {
            document.getElementById('prefillBoard').disabled = 'false';
        }

        function submitSeed() {
            let seedValue = document.getElementById("seedBar").value;
            let settings = SettingsParser.parseSettingsFromSeed(SettingsSchemaSingleton.getInstance().getSettingsSchema(), seedValue);
            if (!(settings === null)) {
                // console.log("Seedbar entered value: " + seedValue);
                document.getElementById("seedBar").value = "";

                document.getElementById("seedingCover").style.visibility = "hidden";
                document.getElementById("seeding").style.visibility = "hidden";

                let settings = SettingsSingleton.getInstance().getSettings();
                SettingsForm.updateForm($('#innerGridForm')[0], settings);
                // this.postProcessSettingsForm(settings);
            } else {
                // TODO: handle error
            }
        }

        function addFlash(elementId) {
            let element = document.querySelector("#" + elementId);
            element.classList.add('FlashOn');
            var millisecondsToWait = 100;
            setTimeout(function () {
                element.classList.remove('FlashOn');
            }, millisecondsToWait);
        }

        function saveGameImage() {
            addFlash("playarea");
            let gameImage = undefined;
            let gameElem = document.getElementById('playarea');

            html2canvas(gameElem).then(function (screeshot) {
                screeshot.setAttribute("class", "screenshot");
                screeshot.style.width = '25vw';
                screeshot.style.height = '15vw';
                screeshot.style.border = "2px solid black";
                gameImage = screeshot;
                pd.visual.saveGameImage(gameImage);
            });
        }

        function loadGameImage(key) {
            pd.visual.loadGame(key);
            pd.loadBoard(pd.visual.getBoard(), "Snapshot");
            var modal = document.getElementById('modalTop');
            modal.style.display = "none";

        }

        function disableSnapshotButton() {
            $('#screenshot').prop('disabled', true);
        }

        function enableSnapshotButton() {
            $('#screenshot').prop('disabled', false);
        }
        function deleteGameImage(key) {
            pd.visual.deleteGameImage(key);
            showGameImages();
        }

        function generateRandomColor() {
            /**
             * https://stackoverflow.com/questions/1152024/
             * best-way-to-generate-a-random-color-in-javascript/1152508
            */

            return '#' + (0x1000000 + Math.random() * 0xffffff).toString(16).substr(1, 6);

        }

        function showGameImages() {
            var modal = document.getElementById('modalTop');
            this.disablePointerEventsOnPieces();
            this.hideManipulationButtons();
            this.hideBubbleContainer();
            modal.style.background = " #eceaea";
            modal.style.display = "block";

            document.querySelector(".modalFormContent").style.display = "none";
            document.querySelector(".innerGrid").style.display = "block";

            let imageList = pd.visual.showGameImages();
            let imageGrid = document.getElementById('innerGrid');
            template.clearContent(".innerGrid");
            template.clearContent("#innerGridForm");
            let gameId = undefined;
            let borderColor = generateRandomColor();

            imageList.forEach((item) => {
                let imgKey = Object.keys(item)[0];
                let image = item[imgKey];
                let imageDiv = document.createElement("div");
                imageDiv.setAttribute("class", "imageDiv");

                if (gameId != pd.visual.getGameIdByKey(imgKey)) {
                    gameId = pd.visual.getGameIdByKey(imgKey);
                    borderColor = generateRandomColor();
                }
                imageDiv.style.borderWidth = "3px";
                imageDiv.style.borderColor = borderColor;

                let buttonDiv = document.createElement("div");
                buttonDiv.setAttribute("class", "imageBtnDiv");

                let loadBtn = document.createElement("button");
                loadBtn.setAttribute("class", "imageButton imageLoadBtn");
                loadBtn.textContent = "Load";
                loadBtn.addEventListener('click', function () {
                    loadGameImage(imgKey);
                }, false);


                let deleteBtn = document.createElement("button");
                deleteBtn.setAttribute("class", "imageButton imageDeleteBtn");
                deleteBtn.textContent = "Delete";
                deleteBtn.addEventListener('click', function () {
                    deleteGameImage(imgKey);
                }, false);


                buttonDiv.appendChild(loadBtn);
                buttonDiv.appendChild(deleteBtn);

                imageDiv.appendChild(image);
                imageDiv.appendChild(buttonDiv);
                imageGrid.appendChild(imageDiv);

            });

        }

        function execReplay() {
            var modal = document.getElementById('modalTop');
            if ($('.modalFormContainer').is(':visible')) {
                this.closeModal();
            }
            else {
                this.disableSnapshotButton();
                this.hideManipulationButtons();
                this.disablePointerEventsOnPieces();
                modal.style.display = "block";
                modal.style.background = "transparent";
                document.querySelector(".modalFormContent").style.display = "block";
                document.querySelector(".innerGrid").style.display = "none";
                template.clearContent("#modalButtonsID");
                template.clearContent("#modalTitleID");
                template.clearContent("#modalBodyID");
                template.clearContent("#innerGridForm");

                let startGameState = pd.getGameState("start");
                let currGameState = pd.getGameState("current");

                if (startGameState == undefined) {
                    let textNode = {
                        name: "modalText",
                        text: "Game Not Started Yet ",
                    }

                    template.attachText("#modalTitleID", textNode);
                    return;
                }

                let allGameState = pd.getAllGameStates();

                let selectStartElem = document.createElement("select");
                selectStartElem.setAttribute("class", "StateSelect");
                selectStartElem.setAttribute("id", "startStateOptions");
                selectStartElem.setAttribute("style", "margin: 0 .5vw;");

                let selectTargetElem = document.createElement("select");
                selectTargetElem.setAttribute("class", "StateSelect");
                selectTargetElem.setAttribute("id", "targetStateOptions");
                selectTargetElem.setAttribute("style", "margin: 0 .5vw;");

                for (let index = 0; index < allGameState.length; ++index) {
                    let optStart = document.createElement('option');
                    let optTarget = document.createElement('option');
                    optStart.value = allGameState[index];
                    optTarget.value = allGameState[index];
                    optStart.innerHTML = allGameState[index];
                    optTarget.innerHTML = allGameState[index];

                    if (allGameState[index] == startGameState) {
                        optStart.selected = "selected";
                        optStart.setAttribute("class", "selected");
                    }
                    else if (allGameState[index] == currGameState) {
                        optTarget.selected = "selected";
                        optTarget.setAttribute("class", "selected");

                    }

                    selectStartElem.appendChild(optStart);
                    selectTargetElem.appendChild(optTarget);
                }

                document.getElementById("modalBodyID").appendChild(selectStartElem);
                document.getElementById("modalBodyID").appendChild(selectTargetElem);

                var submit = document.createElement("input");
                submit.setAttribute("type", "button");
                submit.setAttribute("value", "Submit");
                submit.setAttribute("class", "submitReplay");
                submit.setAttribute("style", "margin: 0 .5vw;background-color:rgb(149, 172, 170);");
                submit.onclick = function () {
                    let replayId = document.getElementById("replay");
                    let replayImg = replayId.children[0];
                    replayImg.setAttribute('src', 'resources/images/icons/pause.png');
                    let sValue = document.getElementById("startStateOptions").value;
                    let eValue = document.getElementById("targetStateOptions").value;
                    console.log(sValue);
                    console.log(eValue);
                    pd.replay(sValue, eValue);
                    modal.style.display = "none";

                }
                document.getElementById("modalBodyID").appendChild(submit);
                this.enableSnapshotButton();
            }
        }

        function loadBoard(selectedBoard) {
            document.getElementById("boardmodalTop").style.display = "none";
            pd.loadBoard(selectedBoard);
            this.closeModalContainer();
        }

        function closeForm() {
            document.getElementById("board_selection_form").style.display = "none";
        }

        function showBubbleContainer(){
            document.getElementById('bubbleContainer').style.display = "block";
        }

        function hideBubbleContainer(){
            document.getElementById('bubbleContainer').style.display = "none";
        }


    </script>
    <script src="./registerSW.js"></script>

</body>

</html>
